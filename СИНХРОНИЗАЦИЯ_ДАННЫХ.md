# Автоматическая синхронизация данных между ботом и мини-приложением

## Проблема
Данные в мини-приложении не обновляются автоматически при изменении в боте.

## Решение: Автоматическая синхронизация

### Вариант 1: Автоматическое копирование при сохранении (Рекомендуется)

При сохранении данных в админ-панели файлы автоматически копируются в `webapp/data/`.

#### Уже реализовано:
- ✅ **Акции** (`promotions.json`) - автоматически копируется при сохранении

#### Нужно добавить для других данных:

1. **Услуги** (`services.json`)
2. **Врачи** (`doctors.json`)
3. **Анализы** (`lab_tests_categorized.json`)
4. **Подготовка** (`analyses_preparation.json`, `procedures_preparation.json`)

### Вариант 2: Скрипт синхронизации (Альтернатива)

Создать скрипт, который будет запускаться периодически или вручную.

### Вариант 3: Git + CI/CD (Для продвинутых)

Настроить автоматический деплой на Vercel при изменении файлов в Git.

---

## Инструкция по настройке

### Шаг 1: Автоматическое копирование при сохранении

#### Для акций (уже работает):
Файл `admin/promotions_management.py` автоматически копирует файл при сохранении.

#### Для других данных нужно добавить аналогичный код:

**Пример для услуг:**
```python
# В функции save_services() добавить:
def save_services(data: Dict) -> bool:
    # ... существующий код сохранения ...
    
    # Копируем файл в webapp/data для мини-приложения
    try:
        webapp_services_file = (
            SERVICES_FILE.parent.parent.parent / "webapp" / "data" /
            "medical" / "services.json"
        )
        if webapp_services_file.parent.exists():
            webapp_services_file.parent.mkdir(parents=True, exist_ok=True)
            shutil.copy2(SERVICES_FILE, webapp_services_file)
            logger.info(f"Услуги скопированы в webapp: {webapp_services_file}")
    except Exception as copy_error:
        logger.warning(f"Не удалось скопировать услуги в webapp: {copy_error}")
```

### Шаг 2: Настройка автоматического деплоя на Vercel

#### Вариант A: Через Vercel CLI (Рекомендуется)

1. Установите Vercel CLI:
```bash
npm install -g vercel
```

2. Войдите в Vercel:
```bash
vercel login
```

3. Свяжите проект:
```bash
cd webapp
vercel link
```

4. Настройте автоматический деплой:
```bash
vercel --prod
```

#### Вариант B: Через Git (Автоматически)

1. Создайте репозиторий Git (если еще нет)
2. Подключите Vercel к репозиторию
3. При каждом коммите в папку `webapp/` Vercel автоматически обновит сайт

### Шаг 3: Скрипт для ручной синхронизации

Создайте файл `sync_webapp_data.ps1` в корне проекта:

```powershell
# Скрипт синхронизации данных для мини-приложения
# Запуск: powershell -ExecutionPolicy Bypass -File sync_webapp_data.ps1

Write-Host "Синхронизация данных для мини-приложения..." -ForegroundColor Green

# Создаем папки
$webappDataPath = "webapp\data"
New-Item -ItemType Directory -Force -Path "$webappDataPath\medical" | Out-Null
New-Item -ItemType Directory -Force -Path "$webappDataPath\preparation" | Out-Null
New-Item -ItemType Directory -Force -Path "$webappDataPath\clinic" | Out-Null

# Копируем файлы
$files = @(
    @{Source="data\medical\lab_tests_categorized.json"; Dest="$webappDataPath\medical\lab_tests_categorized.json"},
    @{Source="data\medical\doctors.json"; Dest="$webappDataPath\medical\doctors.json"},
    @{Source="data\medical\services.json"; Dest="$webappDataPath\medical\services.json"},
    @{Source="data\medical\promotions.json"; Dest="$webappDataPath\medical\promotions.json"},
    @{Source="data\preparation\analyses_preparation.json"; Dest="$webappDataPath\preparation\analyses_preparation.json"},
    @{Source="data\preparation\procedures_preparation.json"; Dest="$webappDataPath\preparation\procedures_preparation.json"},
    @{Source="data\clinic\contacts.json"; Dest="$webappDataPath\clinic\contacts.json"}
)

foreach ($file in $files) {
    if (Test-Path $file.Source) {
        Copy-Item $file.Source -Destination $file.Dest -Force
        Write-Host "✓ Скопирован $(Split-Path $file.Source -Leaf)" -ForegroundColor Green
    } else {
        Write-Host "⚠ Файл не найден: $($file.Source)" -ForegroundColor Yellow
    }
}

Write-Host ""
Write-Host "Готово! Данные синхронизированы." -ForegroundColor Green
Write-Host ""
Write-Host "Следующие шаги:" -ForegroundColor Yellow
Write-Host "1. Загрузите папку webapp на Vercel" -ForegroundColor Yellow
Write-Host "2. Или используйте: cd webapp && vercel --prod" -ForegroundColor Yellow
```

### Шаг 4: Автоматизация через планировщик задач (Windows)

1. Откройте "Планировщик заданий" Windows
2. Создайте новую задачу
3. Настройте запуск скрипта `sync_webapp_data.ps1` по расписанию (например, каждый час)

---

## Рекомендуемый рабочий процесс

### Ежедневная работа:

1. **Изменяете данные в админ-панели бота**
   - Акции автоматически копируются ✅
   - Для других данных запустите скрипт синхронизации

2. **Запускаете скрипт синхронизации** (если нужно):
   ```powershell
   powershell -ExecutionPolicy Bypass -File sync_webapp_data.ps1
   ```

3. **Загружаете на Vercel**:
   ```bash
   cd webapp
   vercel --prod
   ```
   
   Или через Git (если настроен):
   ```bash
   git add webapp/
   git commit -m "Обновление данных мини-приложения"
   git push
   ```

### Автоматизация (Продвинутый вариант):

1. Настройте Git репозиторий
2. Подключите Vercel к репозиторию
3. При каждом изменении файлов в `webapp/` Vercel автоматически обновит сайт
4. Добавьте автоматическое копирование файлов при сохранении в админ-панели

---

## Проверка синхронизации

1. Измените данные в админ-панели бота
2. Проверьте, что файлы скопированы в `webapp/data/`
3. Загрузите на Vercel
4. Откройте мини-приложение и проверьте, что данные обновились

---

## Отладка

Если данные не обновляются:

1. **Проверьте файлы в `webapp/data/`**:
   - Убедитесь, что файлы скопированы
   - Проверьте дату изменения файлов

2. **Проверьте консоль браузера** (F12):
   - Должны быть сообщения "Акции обновлены, версия: ..."
   - Если нет - проверьте загрузку JSON файлов

3. **Проверьте Vercel**:
   - Убедитесь, что файлы загружены на сервер
   - Проверьте доступность по HTTPS

4. **Очистите кэш браузера**:
   - Нажмите Ctrl+F5 в мини-приложении
   - Или откройте в режиме инкогнито

---

## Быстрая команда для синхронизации

Создайте файл `sync.bat` в корне проекта:

```batch
@echo off
echo Синхронизация данных для мини-приложения...
powershell -ExecutionPolicy Bypass -File sync_webapp_data.ps1
pause
```

Запускайте двойным кликом после изменения данных в боте.

